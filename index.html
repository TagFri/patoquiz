<!doctype html>
<html lang="no">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tilfeldig patologi case</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; line-height: 1.4; }
        .wrap { max-width: 1600px; margin: 0 auto; display: grid; gap: 12px; }
        .header, .box, #revealBtn, #nextBtn, #iframeContainer, #snittLinks, .footer { max-width: 1200px; width: 100%; justify-self: center; }
        .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .muted { color: #666; font-size: 14px; }
        .box { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
        pre { white-space: pre-wrap; margin: 0; }

        button { 
            padding: 10px 14px; 
            border-radius: 10px; 
            border: 1px solid #111; 
            background: #111; 
            color: #fff; 
            cursor: pointer; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 40px; 
            user-select: none; 
            -webkit-user-select: none;
            font-family: inherit;
        }
        button.secondary { background: #fff; color: #111; }
        button.outline { background: transparent; color: #111; border: 1px solid #ddd; }
        button:disabled { opacity: .6; cursor: not-allowed; }
        .bmc-button { height: 40px !important; line-height: 40px !important; font-size: 14px !important; display: inline-flex !important; align-items: center !important; border-radius: 10px !important; }

        .header { margin-bottom: 10px; }
        .row-1 { border-bottom: 1px solid #eee; }
        .row-2 { margin-top: 1rem;}
        .header-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; gap: 10px; }
        .header-row .left, .header-row .middle, .header-row .right { display: flex; gap: 10px; align-items: center; flex: 1; }
        .header-row .middle { justify-content: center; }
        .header-row .right { justify-content: flex-end; }
        .mode-selector { background: #f9f9f9; padding: 10px; border-radius: 10px; margin-bottom: 12px; }
        .rating-btns { display: flex; gap: 8px; margin-top: 15px; width: 100%; }
        .rating-btns button { flex: 1; padding: 12px 5px; font-size: 13px; }
        .btn-easy { background: #28a745; border-color: #28a745; }
        .btn-hard { background: #ffc107; border-color: #ffc107; color: #000; }
        .btn-impossible { background: #dc3545; border-color: #dc3545; }
        .btn-super-easy { background: #007bff; border-color: #007bff; }


        .imgWrap { position: relative; }
        .case-img {
            width: 100%;
            height: auto;
            max-height: 80vh;
            display: block;
            background: #111;
            border-radius: 10px;
            object-fit: contain;
        }
        .navBtn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 999px;
            width: 42px;
            height: 42px;
            display: none;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0,0,0,0.25);
            background: rgba(0,0,0,0.55);
            color: #fff;
            cursor: pointer;
            user-select: none;
        }
        .navBtn:hover { background: rgba(0,0,0,0.7); }
        .navBtn.left { left: 10px; }
        .navBtn.right { right: 10px; }
        .imgCounter {
            position: absolute;
            right: 10px;
            bottom: 10px;
            background: rgba(0,0,0,0.55);
            color: #fff;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px;
            display: none;
            user-select: none;
        }

        .imgLabel {
            position: absolute;
            left: 10px;
            top: 10px;
            background: rgba(0,0,0,0.55);
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 18px;
            font-weight: bold;
            display: none;
            user-select: none;
            pointer-events: none;
        }

        details summary { cursor: pointer; font-weight: 600; }
        details .content { margin-top: 8px; }

        #sr-status { font-weight: 600; color: #111; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 14px; opacity: 0; transition: opacity 0.3s; z-index: 1000; pointer-events: none; }
        
        #microscopeIframe {
            width: 100%;
            height: 700px;
            border: 1px solid #ddd;
            border-radius: 10px;
        }
        .slide-btn {
            margin-right: 8px;
            margin-bottom: 8px;
            padding: 8px 12px;
            font-size: 14px;
        }
        .slide-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: #fff;
        }
        #uioLink {
            display: inline-block;
            margin-top: 15px;
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
        }
        #uioLink:hover {
            text-decoration: underline;
        }
        @media (max-width: 600px) {
            #microscopeIframe {
                height: 450px;
            }
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            padding-bottom: 40px;
        }

        .footer h3 {
            color: #111;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .footer p {
            margin: 5px 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>
<div id="toast" class="toast"></div>
<div class="wrap">
    <div class="header">
        <div class="header-row row-1">
            <div class="left">
                <div class="muted" id="sr-status" style="display:none;"></div>
                <div id="userInfo" class="muted">Laster bruker...</div>
            </div>
            <div class="right">
                <button id="deleteProgressBtn" type="button" class="outline" style="display:none; color: #dc3545; border-color: #dc3545; font-size: 12px; padding: 8px 10px;">Slett progresjon</button>
                <button id="reportErrorBtn" type="button" class="outline" style="display:none; font-size: 12px; padding: 8px 10px;">Rapporter feil/tips</button>
                <button id="loginBtn" type="button" style="display:none;">Logg inn</button>
                <button class="logoutBtn outline" type="button" style="display:none;">Logg ut</button>
            </div>
        </div>

        <div class="header-row row-2" id="row2">
            <div class="left" style="flex: 3; display: flex; gap: 10px;">
                <input type="text" id="caseSearchInput" placeholder="Søk på casenummer eller casetittel..." list="caseList" style="width: 50%; padding: 10px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit; font-size: 14px; box-sizing: border-box;">
                <datalist id="caseList"></datalist>
                <button id="searchBtn" type="button" class="outline" style="font-size: 14px;">Åpne case</button>
            </div>
            <div class="right">
            </div>
        </div>
    </div>

    <div class="box" id="oppBox" style="display:none;">
        <strong id="oppTitle">Opplysninger</strong> <span class="muted" id="status"></span>
        <pre id="opp"></pre>
    </div>

    <div id="snittLinks" style="display:none; margin: 20px 0;"></div>

    <div id="iframeContainer" style="display:none; margin: 20px 0;">
        <div id="slideSwitcher" style="margin-bottom: 10px;"></div>
        <iframe id="microscopeIframe" src="" allowfullscreen></iframe>
    </div>

    <button id="revealBtn" type="button" class="secondary">Vis fasit</button>

    <div class="box" id="fasitBox" style="display:none;">
        <div style="margin-top:10px;">
            <div id="title" style="font-weight:700;">—</div>
        </div>

        <div style="margin-top:12px;">
            <pre id="beskrivelse"></pre>
        </div>

        <a id="uioLink" href="#" target="_blank" style="display: none;">Lenke til UiO nettside</a>

        <div class="rating-btns" id="ratingBtns" style="display:none;">
            <button id="btn-not-possible" class="btn-impossible" type="button" onclick="rateCase('not_possible')">Ikke mulig</button>
            <button id="btn-hard" class="btn-hard" type="button" onclick="rateCase('hard')">Vanskelig</button>
            <button id="btn-easy" class="btn-easy" type="button" onclick="rateCase('easy')">Lett</button>
            <button id="btn-super-easy" class="btn-super-easy" type="button" onclick="rateCase('super_easy')">Superlett</button>
        </div>
    </div>
    <button id="nextBtn" type="button" style="margin-top: 20px; display: none;">Neste case</button>
    <footer class="footer">
        <h3>Patoquiz - gjort bedre!</h3>
        <p>Vipps-donasjon til 41886 for drift og videreutvikling gir god karma!</p>.
        <p>Pengene går til å holde siden i live og mindre cranky. Kanskje en kaffekopp til programmeringen på sene
            kvelder</p>
    </footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, getDoc, getDocs, setDoc, deleteDoc, collection, serverTimestamp, onSnapshot, enableMultiTabIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

   const firebaseConfig = {
      apiKey: "AIzaSyApBRM1coRJnGaLFOrKGKXlEdPhr_AAaN4",
      authDomain: "patoquiz-142f2.firebaseapp.com",
      projectId: "patoquiz-142f2",
      storageBucket: "patoquiz-142f2.firebasestorage.app",
      messagingSenderId: "46098075285",
      appId: "1:46098075285:web:52a68f1203d7ab3040559c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Enable persistence to reduce reads and allow offline access
    enableMultiTabIndexedDbPersistence(db).catch((err) => {
        if (err.code === 'failed-precondition') {
            console.warn("Persistence failed: Multiple tabs open.");
        } else if (err.code === 'unimplemented') {
            console.warn("Persistence failed: Browser doesn't support it.");
        }
    });

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    const nextBtn = document.getElementById("nextBtn");
    const revealBtn = document.getElementById("revealBtn");
    const statusEl = document.getElementById("status");
    const srStatusEl = document.getElementById("sr-status");
    const userInfoEl = document.getElementById("userInfo");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtns = document.querySelectorAll(".logoutBtn");
    const ratingBtns = document.getElementById("ratingBtns");
    const toastEl = document.getElementById("toast");
    const deleteProgressBtn = document.getElementById("deleteProgressBtn");
    const reportErrorBtn = document.getElementById("reportErrorBtn");
    const snittLinks = document.getElementById("snittLinks");
    const iframeContainer = document.getElementById("iframeContainer");
    const microscopeIframe = document.getElementById("microscopeIframe");
    const slideSwitcher = document.getElementById("slideSwitcher");
    const uioLink = document.getElementById("uioLink");

    const caseSearchInput = document.getElementById("caseSearchInput");
    const caseList = document.getElementById("caseList");
    const searchBtn = document.getElementById("searchBtn");

    const oppBox = document.getElementById("oppBox");
    const oppEl = document.getElementById("opp");
    const oppTitle = document.getElementById("oppTitle");

    const fasitBox = document.getElementById("fasitBox");
    const titleEl = document.getElementById("title");
    const beskrivelseEl = document.getElementById("beskrivelse");

    let allCaseIds = [];       // just IDs from metadata
    let caseNamesById = {};    // ID -> Title
    let userProgress = {};     // caseId -> progressDoc
    let progressListener = null; // Unsubscribe function
    let metadataListener = null; // Unsubscribe function
    let currentCase = null;    // current object
    let imgUrls = [];          // urls for current case
    let revealed = false;      // fasit shown?
    let user = null;
    let ratingBusy = false;

    function calculateNextInterval(rating, progress) {
        const repetitions = progress.repetitions || 0;
        const intervalDays = progress.intervalDays || 0;
        const easeFactor = progress.easeFactor || 2.5;
        
        if (repetitions === 0) {
            if (rating === 'not_possible') return 1;
            if (rating === 'hard') return 3;
            if (rating === 'easy') return 10;
            if (rating === 'super_easy') return 365;
        }
        
        if (rating === 'not_possible') return 1;
        
        let res;
        if (rating === 'hard') res = Math.max(intervalDays * 1.2, intervalDays + 1);
        else if (rating === 'easy') res = intervalDays * easeFactor;
        else if (rating === 'super_easy') res = intervalDays * easeFactor * 1.5;
        else res = 1;
        
        return res >= 1 ? Math.round(res) : res;
    }

    function formatInterval(days) {
        if (days >= 365) return "Ikke repeter";
        if (days < 0.05) { // Rundt 1 time eller mindre
            const mins = Math.round(days * 1440);
            return mins + " min";
        }
        if (days < 60) {
            const d = Math.round(days);
            return d + (d === 1 ? " dag" : " dager");
        }
        if (days < 365) {
            const m = Math.round(days / 30);
            return m + (m === 1 ? " mnd" : " mnd");
        }
        const y = Math.round(days / 365);
        return y + (y === 1 ? " år" : " år");
    }

    function setStatus(msg) {
        if (statusEl) statusEl.textContent = msg;
        console.log("Status update:", msg);
    }

    function showToast(msg) {
        toastEl.textContent = msg;
        toastEl.style.opacity = "1";
        setTimeout(() => toastEl.style.opacity = "0", 2500);
    }

    function updateStatusLine() {
        if (!user) {
            srStatusEl.style.display = "none";
            return;
        }
        const now = new Date();
        const dueCount = allCaseIds.filter(id => {
            const p = userProgress[id];
            return p && p.nextDueAt && p.nextDueAt.toDate() <= now;
        }).length;
        const newCount = allCaseIds.filter(id => !userProgress[id]).length;
        
        srStatusEl.style.display = "block";
        srStatusEl.textContent = `Due: ${dueCount} | Nye: ${newCount} (${allCaseIds.length} totalt)`;
    }

    // Auth logic
    loginBtn.addEventListener("click", async () => {
        try {
            await signInWithPopup(auth, provider);
        } catch (e) {
            console.error("Firebase Auth Error:", e);
            let msg = "Innlogging feilet";
            if (e.code === "auth/unauthorized-domain") {
                msg = "Feil: Domenet er ikke godkjent i Firebase Console.";
            } else if (e.code === "auth/popup-closed-by-user") {
                return;
            } else if (e.code === "auth/operation-not-allowed") {
                msg = "Feil: Google-innlogging er ikke aktivert i Firebase.";
            } else {
                msg += ": " + (e.code || "Ukjent feil");
            }
            showToast(msg);
        }
    });

    logoutBtns.forEach(btn => btn.addEventListener("click", () => signOut(auth)));

    if (window.location.protocol === 'file:') {
        console.warn("Firebase Auth fungerer ofte ikke via file:// protokollen.");
    }

    let authInitialized = false;
    onAuthStateChanged(auth, async (u) => {
        user = u;
        if (u) {
            userInfoEl.textContent = "";
            loginBtn.style.display = "none";
            logoutBtns.forEach(btn => btn.style.display = "block");
            deleteProgressBtn.style.display = "block";
            await fetchUserProgress();
        } else {
            userInfoEl.textContent = "Logg inn for å vise progresjon";
            loginBtn.style.display = "block";
            logoutBtns.forEach(btn => btn.style.display = "none");
            deleteProgressBtn.style.display = "none";
            userProgress = {};
            if (progressListener) {
                progressListener();
                progressListener = null;
            }
        }
        updateStatusLine();
        
        if (allCaseIds.length === 0) {
            await loadMetadata();
        } else {
            updateStatusLine();
        }

        if (!authInitialized) {
            authInitialized = true;
            nextCase();
        }
    });

    async function fetchUserProgress() {
        if (!user) return;
        if (progressListener) progressListener();
        
        return new Promise((resolve) => {
            progressListener = onSnapshot(collection(db, `users/${user.uid}/caseProgress`), (snap) => {
                userProgress = {};
                snap.forEach(doc => {
                    userProgress[doc.id] = doc.data();
                });
                updateStatusLine();
                resolve(userProgress);
            }, (e) => {
                console.error("Feil ved henting av progresjon", e);
                resolve({});
            });
        });
    }


    function pickRandom(arr) {
        if (!arr.length) return null;
        return arr[Math.floor(Math.random() * arr.length)];
    }

    function normalizeCaseId(c) {
        // Your import may set numeric id in c.id, but Firestore doc id is a string too.
        // Prefer numeric field if present.
        return (typeof c.id === "number" ? c.id : (Number.isFinite(+c.id) ? +c.id : c.id));
    }

    function getImageUrls(c) {
        let urls = [];
        if (Array.isArray(c.image_urls)) {
            urls = c.image_urls;
        } else if (Array.isArray(c.images)) {
            urls = c.images.map(x => x?.downloadUrl || x?.url || x?.src).filter(Boolean);
        }
        // dedupe while preserving order
        const seen = new Set();
        const out = [];
        for (const u of urls) {
            if (u && !seen.has(u)) {
                seen.add(u);
                out.push(u);
            }
        }
        return out;
    }


    function hideFasit() {
        revealed = false;
        fasitBox.style.display = "none";
        revealBtn.textContent = "Vis fasit";
        ratingBtns.style.display = "none";
        nextBtn.style.display = "none";
    }

    function showFasit() {
        if (!currentCase) return;
        revealed = true;
        fasitBox.style.display = "";
        revealBtn.textContent = "Skjul fasit";

        const theme = currentCase.theme ?? "";
        const title = currentCase.title ?? "";
        const answer = currentCase.answer ?? "—";

        titleEl.textContent = `${theme} -> ${title}`.trim() || "—";
        beskrivelseEl.textContent = answer;

        if (currentCase.url) {
            uioLink.href = currentCase.url;
            uioLink.style.display = "inline-block";
        } else {
            uioLink.style.display = "none";
        }

        if (user) {
            const caseId = String(currentCase.id);
            const progress = userProgress[caseId] || {
                repetitions: 0,
                intervalDays: 0,
                easeFactor: 2.5
            };

            document.getElementById('btn-not-possible').textContent = formatInterval(calculateNextInterval('not_possible', progress));
            document.getElementById('btn-hard').textContent = formatInterval(calculateNextInterval('hard', progress));
            document.getElementById('btn-easy').textContent = formatInterval(calculateNextInterval('easy', progress));
            document.getElementById('btn-super-easy').textContent = formatInterval(calculateNextInterval('super_easy', progress));

            ratingBtns.style.display = "flex";
            setTimeout(() => {
                ratingBtns.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 50);
        } else {
            nextBtn.style.display = "block";
            setTimeout(() => {
                nextBtn.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 50);
        }
    }

    window.rateCase = async (rating) => {
        if (!user || !currentCase || ratingBusy) return;
        ratingBusy = true;
        
        const btns = ratingBtns.querySelectorAll('button');
        btns.forEach(b => b.disabled = true);
        
        const caseId = String(currentCase.id);
        const progress = userProgress[caseId] || {};

        let repetitions = progress.repetitions || 0;
        let lapses = progress.lapses || 0;
        let easeFactor = progress.easeFactor || 2.5;
        let intervalDays = progress.intervalDays || 0;
        
        const nextInterval = calculateNextInterval(rating, progress);

        if (rating === "super_easy") {
            repetitions++;
            easeFactor = Math.min(5.0, easeFactor + 0.15);
        } else if (rating === "easy") {
            repetitions++;
            easeFactor = Math.min(5.0, easeFactor + 0.05);
        } else if (rating === "hard") {
            repetitions++;
            easeFactor = Math.max(1.3, easeFactor - 0.15);
        } else if (rating === "not_possible") {
            lapses++;
            repetitions = 0;
            easeFactor = Math.max(1.3, easeFactor - 0.20);
        }
        intervalDays = nextInterval;

        const nextDueAt = new Date(Date.now() + intervalDays * 24 * 60 * 60 * 1000);

        const newProgress = {
            status: "done",
            rating: rating,
            lastReviewedAt: serverTimestamp(),
            nextDueAt: nextDueAt,
            intervalDays: intervalDays,
            easeFactor: easeFactor,
            repetitions: repetitions,
            lapses: lapses
        };

        try {
            await setDoc(doc(db, `users/${user.uid}/caseProgress`, caseId), newProgress);
            userProgress[caseId] = { ...newProgress, nextDueAt: { toDate: () => nextDueAt } };
            showToast(`Lagret – neste repetisjon: ${nextDueAt.toLocaleDateString('no-NO')}`);
            updateStatusLine();
            setTimeout(() => {
                nextCase();
            }, 800);
        } catch (e) {
            console.error(e);
            showToast("Kunne ikke lagre progresjon");
            btns.forEach(b => b.disabled = false);
            ratingBusy = false;
        }
    };

    function renderCase(c) {
        ratingBusy = false;
        // Alltid re-aktiver knapper når en ny case rendres
        if (revealBtn) revealBtn.disabled = false;
        if (nextBtn) nextBtn.disabled = false;
        if (ratingBtns) {
            ratingBtns.querySelectorAll('button').forEach(b => b.disabled = false);
        }

        if (!c) {
            currentCase = null;
            setStatus("Ingen flere caser i denne modusen.");
            oppBox.style.display = "none";
            snittLinks.style.display = "none";
            iframeContainer.style.display = "none";
            microscopeIframe.src = "";
            revealBtn.style.display = "none";
            reportErrorBtn.style.display = "none";
            hideFasit();
            return;
        }
        currentCase = c;
        revealBtn.style.display = "";
        reportErrorBtn.style.display = "";

        let slides = [];
        if (Array.isArray(c.slides)) {
            slides = c.slides;
            imgUrls = slides.map(s => s.url);
        } else {
            imgUrls = getImageUrls(c);
            slides = imgUrls.map((url, i) => ({
                url: url,
                n: i + 1,
                stain: null
            }));
        }
        hideFasit();

        // Slide switcher
        slideSwitcher.innerHTML = "";
        if (slides.length > 1) {
            slides.forEach((slide, i) => {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "slide-btn outline";
                if (i === 0) btn.classList.add("active");

                let label = `Snitt ${slide.n || (i + 1)}`;
                if (slide.stain) {
                    label += ` - ${slide.stain}`;
                }
                btn.textContent = label;

                btn.onclick = () => {
                    microscopeIframe.src = slide.url;
                    slideSwitcher.querySelectorAll(".slide-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                };
                slideSwitcher.appendChild(btn);
            });
            slideSwitcher.style.display = "block";
        } else {
            slideSwitcher.style.display = "none";
        }

        // Microscope iframe
        if (slides.length > 0) {
            microscopeIframe.src = slides[0].url;
            iframeContainer.style.display = "block";
        } else {
            microscopeIframe.src = "";
            iframeContainer.style.display = "none";
        }

        /*
        // Snitt links
        snittLinks.innerHTML = "";
        slides.forEach((slide, i) => {
            const h1 = document.createElement('h1');
            const a = document.createElement('a');
            a.href = slide.url;
            a.target = "_blank";
            
            let label = slides.length > 1 ? `Mikroskopisnitt ${slide.n || (i + 1)}` : "Mikroskopisnitt";
            if (slide.stain) {
                label += ` - ${slide.stain}`;
            }
            a.textContent = label;
            
            h1.appendChild(a);
            snittLinks.appendChild(h1);
        });
        snittLinks.style.display = slides.length ? "block" : "none";
        */

        // Caseinfo
        oppTitle.textContent = `Case ${normalizeCaseId(c)}`;
        oppEl.textContent = `${c.history || "—"}`;

        oppBox.style.display = "";

        setTimeout(() => {
            oppBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);

        const p = userProgress[c.id];
        let statusText = "";
        if (p && p.nextDueAt) {
            statusText = `- repetisjon`;
        }
        setStatus(statusText);
    }

    async function nextCase() {
        try {
            const ids = await loadMetadata();
            if (!ids.length) {
                // Feilmelding er allerede satt i loadMetadata
                return;
            }

            let pool = ids;
            if (user) {
                const now = new Date();
                const dueIds = ids.filter(id => {
                    const p = userProgress[id];
                    return p && p.nextDueAt && p.nextDueAt.toDate() <= now;
                });
                const newIds = ids.filter(id => !userProgress[id]);

                // Normal mode: due first, then new
                pool = dueIds.length > 0 ? dueIds : newIds;
            }

            if (pool.length === 0) {
                renderCase(null);
            } else {
                const targetId = pickRandom(pool);
                nextBtn.disabled = true;
                revealBtn.disabled = true;
                
                const c = await fetchCaseById(targetId);
                renderCase(c);
            }
        } catch (e) {
            console.error(e);
            setStatus("Feil: " + (e?.message || e));
            nextBtn.disabled = false;
            revealBtn.disabled = false;
        }
    }

    function populateSearchList(byId) {
        caseNamesById = byId;
        caseList.innerHTML = "";
        const ids = Object.keys(byId).sort((a, b) => Number(a) - Number(b));
        ids.forEach(id => {
            // Option for ID
            const optId = document.createElement("option");
            optId.value = id;
            caseList.appendChild(optId);

            // Option for Title
            const title = byId[id];
            if (title) {
                const optTitle = document.createElement("option");
                optTitle.value = title;
                caseList.appendChild(optTitle);
            }
        });
    }

    async function openSearchedCase() {
        const val = caseSearchInput.value.trim();
        if (!val) return;
        
        let caseId = null;

        // 1. Er det en kjent ID?
        if (allCaseIds.includes(val)) {
            caseId = val;
        } else {
            // 2. Er det en kjent tittel?
            for (const [id, title] of Object.entries(caseNamesById)) {
                if (title === val) {
                    caseId = id;
                    break;
                }
            }
        }

        // 3. Fallback for gammelt format "ID: Tittel"
        if (!caseId && val.includes(":")) {
            const possibleId = val.split(":")[0].trim();
            if (allCaseIds.includes(possibleId)) {
                caseId = possibleId;
            }
        }
        
        if (caseId) {
            try {
                // Skjul keyboard på mobil ved å fjerne fokus
                caseSearchInput.blur();
                const c = await fetchCaseById(caseId);
                renderCase(c);
                caseSearchInput.value = "";
            } catch (e) {
                console.error(e);
                showToast(`Fant ikke case ${caseId}`);
                setStatus("");
            }
        }
    }

    let metadataPromise = null;
    async function loadMetadata() {
        if (allCaseIds.length) return allCaseIds;
        if (metadataPromise) return metadataPromise;

        metadataPromise = new Promise((resolve, reject) => {
            setStatus("Laster konfigurasjon…");
            nextBtn.disabled = true;
            revealBtn.disabled = true;

            // Fetch case names for search
            onSnapshot(doc(db, "metadata", "caseName"), (snap) => {
                if (snap.exists()) {
                    caseNamesById = snap.data().byId || {};
                    // Ikke populær listen før man begynner å skrive
                    if (caseSearchInput.value.trim()) {
                        populateSearchList(caseNamesById);
                    } else {
                        caseList.innerHTML = "";
                    }
                }
            });

            // Fetch a single metadata document that lists all case IDs
            metadataListener = onSnapshot(doc(db, "metadata", "config"), (snap) => {
                if (snap.exists()) {
                    allCaseIds = snap.data().allCaseIds || [];
                } else {
                    console.warn("metadata/config not found.");
                    allCaseIds = [];
                }
                
                nextBtn.disabled = false;
                nextBtn.style.display = "block";
                revealBtn.disabled = false;
                setStatus(allCaseIds.length ? "" : "Fant ingen caser. Kjør import_cases.js.");
                updateStatusLine();
                
                resolve(allCaseIds);
            }, (e) => {
                console.error(e);
                setStatus("Kunne ikke laste konfigurasjon: " + e.message);
                metadataPromise = null;
                nextBtn.disabled = false;
                revealBtn.disabled = false;
                reject(e);
            });
        });
        return metadataPromise;
    }

    async function fetchCaseById(caseId) {
        // Individual case fetch (benefitting from persistence/cache)
        const d = await getDoc(doc(db, "cases", String(caseId)));
        if (!d.exists()) {
            throw new Error(`Case ${caseId} finnes ikke i Firestore.`);
        }
        return { id: d.id, ...d.data() };
    }

    nextBtn.addEventListener("click", nextCase);
    searchBtn.addEventListener("click", openSearchedCase);
    caseSearchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") openSearchedCase();
    });
    caseSearchInput.addEventListener("input", (e) => {
        const val = caseSearchInput.value.trim();
        
        if (val.length > 0) {
            if (caseList.children.length === 0) {
                populateSearchList(caseNamesById);
            }
        } else {
            caseList.innerHTML = "";
        }

        // Åpne case automatisk kun hvis det er et valg fra dropdown (inputType er undefined i de fleste nettlesere)
        if (val && !e.inputType) {
            const options = caseList.options;
            for (let i = 0; i < options.length; i++) {
                if (options[i].value === val) {
                    openSearchedCase();
                    break;
                }
            }
        }
    });
    deleteProgressBtn.addEventListener("click", async () => {
        if (!user || !confirm("Er du sikker på at du vil slette ALL progresjon? Dette kan ikke angres.")) return;
        
        try {
            const snap = await getDocs(collection(db, `users/${user.uid}/caseProgress`));
            const deletePromises = [];
            snap.forEach(docSnap => {
                deletePromises.push(deleteDoc(doc(db, `users/${user.uid}/caseProgress`, docSnap.id)));
            });
            await Promise.all(deletePromises);
            userProgress = {};
            updateStatusLine();
            showToast("Progresjon slettet");
            nextCase();
        } catch (e) {
            console.error("Feil ved sletting av progresjon", e);
            showToast("Kunne ikke slette progresjon");
        }
    });

    revealBtn.addEventListener("click", () => {
        if (revealed) hideFasit();
        else showFasit();
    });

    reportErrorBtn.addEventListener("click", () => {
        if (currentCase) {
            const caseId = normalizeCaseId(currentCase);
            const subject = encodeURIComponent(`Patoquiz - case ${caseId}`);
            window.location.href = `mailto:aagfriv@gmail.com?subject=${subject}`;
        }
    });

    window.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
            e.preventDefault();
            if (!revealed) {
                showFasit();
            } else if (user) {
                rateCase('easy');
            } else {
                nextCase();
            }
        }
    });
</script>
</body>
</html>
